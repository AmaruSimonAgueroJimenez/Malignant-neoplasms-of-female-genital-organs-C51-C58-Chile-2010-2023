---
title: "Malignant neoplasms of female genital organs C51-C58 in Chile from 2010 to 2023"
author:
  - name: "María Elisa Joannon Ovalle"
    email: "mejoannon@miuandes.cl"
  - name: "Amaru Simón Agüero Jiménez"
    email: "aaguero@miaundes.cl"
    orcid: "0000-0001-7336-1833"

format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    number-depth: 3
    html-math-method: katex
    code-fold: true
    bibliography: ref.bib
    csl: apa-numeric-superscript.csl
---
# Introduction.

```{css, echo=FALSE}
caption {
  caption-side: top;
  text-align: center;
}
```

# Methodology 

## R packages.
```{r}
#| message: false
#| warning: false

install_and_load <- function(package) {
  if (!require(package, character.only = TRUE)) {
    utils::install.packages(package)
    library(package, character.only = TRUE)
  }
}

# List of packages to be installed and loaded
packages <- c("devtools", "renv", "tidyverse", "janitor", "data.table", "flexsurv",
              "kableExtra", "reticulate", "FactoMineR", "factoextra", "knitr","plotly","censo2017", "ggbreak", "patchwork","latex2exp")

# Apply the function to each package
invisible(capture.output(sapply(packages, install_and_load)))

opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
rm(list = ls())
```

## Data Adminstration
```{r, HOSP}
# Define the path for the HOSP.rds file
output_file <- paste0(gsub("docs", "", getwd()), "data/data_output/HOSP.rds")

# Check if the file already exists
if (!file.exists(output_file)) {
  # If the file doesn't exist, execute the code
  
  # Get the list of CSV files in the "data/EGRESOS" folder
  files <- list.files(path = paste0(gsub("docs", "", getwd()), "data/EGRESOS/"), pattern = "\\.csv$", full.names = TRUE)

  # Define the columns you need to select, considering potential variations in the column names
  required_columns <- c("SEXO", "GRUPO_EDAD", "ETNIA", 
                        "GLOSA_PAIS_ORIGEN", "COMUNA_RESIDENCIA", "GLOSA_COMUNA_RESIDENCIA", 
                        "REGION_RESIDENCIA", "GLOSA_REGION_RESIDENCIA", "PREVISION", "GLOSA_PREVISION", 
                        "ANO_EGRESO", "DIAG1", "DIAG2", "DIAS_ESTADA", "CONDICION_EGRESO")

  # Function to read each file and select the required columns
  read_file <- function(file) {
    # Read the data, assuming the delimiter is a semicolon (you can change it if necessary)
    data <- read_delim(file, delim = ";")
    
    # Select the necessary columns (handling cases where the column name is slightly different)
    data_selected <- data %>%
      select(any_of(required_columns)) 
    
    return(data_selected)
  }

  # Load all datasets and name them according to the file name (without extension)
  data_list <- lapply(files, read_file)

  # Assign names to the list elements using the file names without the extension
  names(data_list) <- tools::file_path_sans_ext(basename(files))

  # Combine all datasets into one
  HOSP <- bind_rows(data_list) %>%
    filter(SEXO != "*")

  # Save the combined dataset as an RDS file
  saveRDS(HOSP, file = output_file)

} else {
   # If the file exists, load it
  HOSP <- readRDS(output_file)
}

HOSP <- HOSP %>%
  mutate(across(where(is.character), ~ iconv(., from = "latin1", to = "UTF-8"))) %>%  # Convert all character columns to UTF-8
  mutate(
    GRUPO_EDAD = as.character(GRUPO_EDAD),  # Ensure GRUPO_EDAD is character
    GRUPO_EDAD = recode(GRUPO_EDAD, 
                        `menor de un año` = "0 - 9", 
                        `1 a 9` = "0 - 9"),  # Recode the age groups
    GRUPO_EDAD = gsub(" a ", " - ", GRUPO_EDAD),
    GRUPO_EDAD = gsub(" y más ", " + ", GRUPO_EDAD),# Replace "a" with "-"
    GRUPO_EDAD = as.factor(GRUPO_EDAD)  # Convert back to factor if needed
  )

```


```{r}
# Define the path for the CENSO2017.rds file
output_file_censo <- paste0(gsub("docs", "", getwd()), "data/data_output/CENSO2017.rds")

# Check if the file already exists
if (!file.exists(output_file_censo)) {
  # If the file doesn't exist, download, process, and save the data
  
  # Connect and download census data
  censo_conectar()
  censo_descargar()
  
  # Select relevant columns and mutate data
  CENSO2017 <- censo_tabla("personas")[,c(1,5,6)]
  CENSO2017 <- CENSO2017 %>%
    mutate(p09 = replace(p09, p09 %in% c(132, 131), NA)) %>%
    mutate(p08 = replace(p08, p08 %in% c(3, 0), NA)) %>%
    mutate(SEXO = factor(p08, levels = c(1, 2), labels = c("HOMBRE", "MUJER"))) %>%
    mutate(GRUPO_EDAD = cut(p09,
                           breaks = c(-Inf, 9, 19, 29, 39, 49, 59, 69, 79, 89, Inf),
                           labels = c("0 - 9", "10 - 19", "20 - 29", "30 - 39", "40 - 49", 
                                      "50 - 59", "60 - 69", "70 - 79", "80 - 89", "90 + "),
                           right = FALSE))
  
  # Save the processed dataset as an RDS file
  saveRDS(CENSO2017, file = output_file_censo)
} else {
  # If the file exists, load it
  CENSO2017 <- readRDS(output_file_censo)
}

STDPOPULATION <- CENSO2017 %>% 
  filter(SEXO=="MUJER") %>% 
  group_by(GRUPO_EDAD) %>%
  summarise(n = n(), .groups = 'drop')  %>%
  mutate(MUJER_STD = n*100000/sum(n))

```

## Hospitalization Rates of  Malignant neoplasms of female genital organs C51-C58 ICD chapter standardized by age group.

### Direct standardization rates (DSR) and standardized rates ratio (SRR).

```{r}

```

